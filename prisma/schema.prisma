// Prisma Schema for Turbo Merch Console
// This is the database schema for user management, subscriptions, and usage tracking
//
// To apply changes:
// 1. npx prisma generate (generates TypeScript types)
// 2. npx prisma migrate dev (creates migration and applies to DB)

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ============================================================================
// USER & AUTHENTICATION
// ============================================================================

model User {
  id        String   @id @default(cuid())
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Authentication (Clerk or NextAuth)
  clerkId String? @unique // Clerk user ID
  email   String  @unique
  name    String?
  isAdmin Boolean @default(false) // Admin role for accessing admin panel

  // Subscription
  subscriptionTier   String  @default("free") // 'free' | 'starter' | 'pro' | 'business' | 'enterprise'
  subscriptionStatus String  @default("active") // 'active' | 'cancelled' | 'past_due' | 'trialing'
  stripeCustomerId   String? @unique

  // Grandfathering support
  pricingVersion Int @default(1) // Allows legacy users to keep old pricing

  // Trial tracking
  trialEndsAt       DateTime?
  trialUsed         Boolean   @default(false) // Prevent trial abuse

  // Anonymous session linking
  linkedSessionId String? @unique // Link to AnonymousSession on signup

  // Timestamps
  subscribedAt      DateTime? // When they first subscribed to paid plan
  cancelledAt       DateTime? // When they cancelled (still active until period end)
  subscriptionEndsAt DateTime? // When subscription actually ends

  // Relations
  usage          UsageTracking[]
  designs        DesignHistory[]
  billingRecords BillingRecord[]
  storageAddons  StorageAddon[]

  @@index([email])
  @@index([clerkId])
  @@index([stripeCustomerId])
  @@index([linkedSessionId])
}

// ============================================================================
// ANONYMOUS SESSIONS (Pre-signup tracking)
// ============================================================================

model AnonymousSession {
  id        String   @id @default(cuid())
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  sessionId String @unique // Client-generated session ID (stored in localStorage)

  // Rate limiting
  generationTimestamps Json // Array of Unix timestamps
  generationCount      Int  @default(0)

  // Metadata
  ipAddress String?
  userAgent String?

  // Status
  linkedToUserId String? // Set when user signs up
  isConverted    Boolean @default(false) // True after user signs up

  // Relations
  designs DesignHistory[]

  @@index([sessionId])
  @@index([ipAddress])
  @@index([linkedToUserId])
}

// ============================================================================
// USAGE TRACKING
// ============================================================================

model UsageTracking {
  id        String   @id @default(cuid())
  createdAt DateTime @default(now())

  userId String
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  // Billing period tracking
  billingPeriodStart DateTime // Start of current billing month
  billingPeriodEnd   DateTime // End of current billing month

  // Usage counters
  designsUsedInPeriod Int @default(0) // Total designs generated this billing period
  designsAllowance    Int // Monthly allowance (copied from tier at period start)
  overageDesigns      Int @default(0) // Designs beyond allowance

  // Calculated charges
  overageCharge Decimal @default(0) @db.Decimal(10, 2) // USD owed for overages

  // Last activity
  lastGenerationAt DateTime @default(now())

  // Soft/hard cap tracking
  softCapReached Boolean @default(false) // User was warned about approaching limit
  hardCapReached Boolean @default(false) // User was blocked from further generation

  @@unique([userId, billingPeriodStart])
  @@index([userId])
  @@index([billingPeriodStart])
}

// ============================================================================
// DESIGN HISTORY
// ============================================================================

model DesignHistory {
  id        String   @id @default(cuid())
  createdAt DateTime @default(now())

  userId String?
  user   User?   @relation(fields: [userId], references: [id], onDelete: Cascade)

  // Anonymous session (for pre-signup designs)
  anonymousSessionId String?
  anonymousSession   AnonymousSession? @relation(fields: [anonymousSessionId], references: [id], onDelete: Cascade)

  // Run metadata
  runId      String   @unique // UUID for this generation run
  runConfig  Json     // Stores full RunConfig for reproducibility

  // Core data
  niche         String
  slogan        String?
  designCount   Int
  targetMarket  String

  // Generated content
  listingData Json   // Title, description, tags, pricing
  artPrompt   Json   // Final art prompt used
  imageUrl    String? // Cloudflare R2 URL (latest/primary image)
  imageHistory Json?  // Array of ImageVersion objects: [{imageUrl, promptMode, generatedAt, regenerationIndex}]

  // Image quality metadata
  imageQuality String // 'low' | 'standard' | 'high'
  canDownload  Boolean @default(true) // false for free tier images

  // Vectorized HD image (cached after first HD download)
  vectorizedUrl  String?   // R2 URL to cached vectorized HD image
  vectorizedAt   DateTime? // When the image was vectorized (null = not yet)

  // Files
  csvData Json?   // Parsed CSV data
  zipUrl  String? // URL to downloadable ZIP (expires after retention period)

  // Billing
  wasOverage Boolean @default(false) // Was this design part of overage billing?
  chargeAmount Decimal? @db.Decimal(10, 2) // Amount charged for this design (if overage)

  // ============ ANALYTICS FIELDS ============
  // Generation settings
  promptMode      String?  // 'advanced' | 'simple' - which prompt mode was used
  viralityLevel   Int?     // 0-100 virality slider setting
  shirtColor      String?  // Recommended shirt color used

  // User behavior tracking
  regenerationCount Int @default(0)  // How many times user regenerated the image
  refinementCount   Int @default(0)  // How many times user refined the image (first is free)
  wasDownloaded    Boolean @default(false) // Did user download the package?
  downloadedAt     DateTime? // When user downloaded

  // Time tracking (in seconds)
  generationDuration Int?     // How long image generation took
  timeToFirstAction  Int?     // Seconds from generation complete to first save/download
  timeToDownload     Int?     // Seconds from generation complete to download

  // Quality signals
  userRating        Int?     // 1-5 star rating (future feature)
  wasRegenerated    Boolean @default(false) // True if user regenerated at least once

  // Retention management
  expiresAt DateTime? // When to delete from storage (based on tier retention)
  deletedAt DateTime? // Soft delete timestamp

  // Relation to detailed analytics
  analytics DesignAnalytics?

  @@index([userId])
  @@index([anonymousSessionId])
  @@index([createdAt])
  @@index([expiresAt])
  @@index([runId])
  @@index([promptMode])
  @@index([wasDownloaded])
}

// ============================================================================
// DESIGN ANALYTICS (Detailed behavior tracking)
// ============================================================================

model DesignAnalytics {
  id        String   @id @default(cuid())
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Link to design
  designId String        @unique
  design   DesignHistory @relation(fields: [designId], references: [id], onDelete: Cascade)

  // Research phase data
  searchQuery       String?  // Original search query
  viralityLevel     Int?     // 0-100 slider value
  sourcesUsed       Json?    // ['Google', 'Brave', 'Grok', 'Rabbit Hole']
  researchDuration  Int?     // Seconds spent in research phase

  // Trend selection
  trendTopic        String?  // Selected trend topic
  trendPlatform     String?  // Where trend originated
  trendVolume       String?  // 'High', 'Breakout', 'Rising', etc.

  // Image generation
  promptMode        String?  // 'advanced' | 'simple'
  promptUsed        String?  @db.Text // Actual prompt sent to image model
  shirtColor        String?  // Target shirt color
  generationStartAt DateTime? // When generation started
  generationEndAt   DateTime? // When generation completed

  // Regeneration tracking (array of timestamps)
  regenerations     Json?    // [{timestamp, reason?, promptMode}]

  // User engagement
  listingViewTime   Int?     // Seconds spent viewing listing
  imageViewTime     Int?     // Seconds spent viewing image
  scrollDepth       Int?     // How far user scrolled (0-100)

  // Actions taken
  savedAt           DateTime?
  downloadedAt      DateTime?
  sharedAt          DateTime?
  deletedAt         DateTime?

  // Outcome classification
  outcome           String?  // 'accepted' | 'regenerated' | 'abandoned' | 'downloaded'
  qualitySignal     String?  // 'good' (quick accept) | 'needs_work' (regenerated) | 'poor' (abandoned)

  @@index([designId])
  @@index([promptMode])
  @@index([outcome])
  @@index([createdAt])
}

// ============================================================================
// RESEARCH CACHE (Deduplicate API calls)
// ============================================================================

model ResearchCache {
  id        String   @id @default(cuid())
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Cache key
  queryHash      String   @unique // MD5/SHA hash of normalized query + virality
  originalQuery  String   // Original search query
  viralityLevel  Int      // Virality setting (0-100)

  // Cached data
  trends         Json     // Array of TrendData results
  braveData      Json?    // Raw Brave search results
  grokData       Json?    // Raw Grok analysis
  rabbitHoleData Json?    // Rabbit hole discoveries

  // Metadata
  sourcesUsed    Json     // Which sources contributed
  hitCount       Int      @default(1) // How many times this cache was used
  lastHitAt      DateTime @default(now())

  // Expiration
  expiresAt      DateTime // When cache expires (based on freshness settings)
  isExpired      Boolean  @default(false)

  @@index([queryHash])
  @@index([expiresAt])
  @@index([hitCount])
}

// ============================================================================
// AGGREGATE TREND INSIGHTS (Platform-wide intelligence)
// ============================================================================

model TrendInsight {
  id        String   @id @default(cuid())
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Trend identification
  topic           String   @unique // Normalized trend topic
  firstSeenAt     DateTime // When first discovered on platform
  lastSeenAt      DateTime // Last time a user searched for this

  // Popularity metrics
  searchCount     Int      @default(1) // How many users searched for this
  designCount     Int      @default(0) // How many designs were created
  downloadCount   Int      @default(0) // How many were downloaded
  acceptanceRate  Decimal? @db.Decimal(5, 2) // % of designs accepted without regeneration

  // Quality signals
  avgRegenerations Decimal? @db.Decimal(5, 2) // Average regenerations before accept
  avgTimeToAccept  Int?     // Average seconds to accept design

  // Platform signals
  platforms       Json?    // Which platforms trend appears on
  peakVolume      String?  // Highest volume observed
  sources         Json?    // Which data sources contributed

  // Prompt mode performance
  advancedModeCount   Int @default(0)
  simpleModeCount     Int @default(0)
  advancedAcceptRate  Decimal? @db.Decimal(5, 2)
  simpleAcceptRate    Decimal? @db.Decimal(5, 2)

  // Status
  isActive        Boolean  @default(true) // Still being searched for
  isTrending      Boolean  @default(false) // Currently hot

  @@index([topic])
  @@index([searchCount])
  @@index([downloadCount])
  @@index([lastSeenAt])
  @@index([isTrending])
}

// ============================================================================
// BILLING & INVOICING
// ============================================================================

model BillingRecord {
  id        String   @id @default(cuid())
  createdAt DateTime @default(now())

  userId String
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  // Billing period
  periodStart DateTime
  periodEnd   DateTime

  // Charges
  subscriptionFee Decimal @db.Decimal(10, 2) // Base monthly fee
  overageFee      Decimal @db.Decimal(10, 2) // Overage charges
  totalAmount     Decimal @db.Decimal(10, 2) // Total billed

  // Usage summary
  designsIncluded Int // Allowance for the tier
  designsUsed     Int // Total designs generated
  overageDesigns  Int // Designs beyond allowance
  overageRate     Decimal @db.Decimal(10, 2) // Price per overage design

  // Payment tracking
  stripeInvoiceId  String? @unique
  stripeChargeId   String?
  paymentStatus    String  @default("pending") // 'pending' | 'paid' | 'failed' | 'refunded'
  paidAt           DateTime?

  // Metadata
  tier           String // Tier at time of billing
  pricingVersion Int    @default(1) // For grandfathering

  @@index([userId])
  @@index([periodStart])
  @@index([stripeInvoiceId])
}

// ============================================================================
// RATE LIMITING (Server-side enforcement)
// ============================================================================

model RateLimit {
  id        String   @id @default(cuid())
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  userId String
  key    String // e.g., 'generation:cooldown', 'concurrent_runs'

  // Limit tracking
  count     Int      @default(0)
  resetAt   DateTime
  blockedAt DateTime? // When user was rate limited

  @@unique([userId, key])
  @@index([userId])
  @@index([resetAt])
}

// ============================================================================
// ADMIN & ANALYTICS
// ============================================================================

model AdminLog {
  id        String   @id @default(cuid())
  createdAt DateTime @default(now())

  adminUserId String // User who performed action
  action      String // 'tier_override', 'refund', 'manual_charge', etc.
  targetUserId String? // User affected by action
  metadata    Json?
  notes       String?

  @@index([adminUserId])
  @@index([targetUserId])
  @@index([createdAt])
}

model SystemMetrics {
  id        String   @id @default(cuid())
  createdAt DateTime @default(now())

  date DateTime @unique @db.Date

  // Daily metrics
  totalUsers         Int
  activeUsers        Int // Generated at least 1 design
  newSignups         Int
  newSubscriptions   Int
  cancellations      Int
  churnRate          Decimal @db.Decimal(5, 2)

  // Revenue
  mrr                Decimal @db.Decimal(10, 2) // Monthly Recurring Revenue
  overageRevenue     Decimal @db.Decimal(10, 2) // Overage fees collected
  totalRevenue       Decimal @db.Decimal(10, 2)

  // Usage
  designsGenerated   Int
  apiCosts           Decimal @db.Decimal(10, 2) // Claude + DALL-E costs
  storageCosts       Decimal @db.Decimal(10, 2) // R2 costs
  profitMargin       Decimal @db.Decimal(5, 2)

  @@index([date])
}

// ============================================================================
// STORAGE ADDONS (Extended Retention)
// ============================================================================

model StorageAddon {
  id        String   @id @default(cuid())
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  userId String
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  // Addon details
  addonType       String   @default("extended_retention") // 'extended_retention', 'unlimited_storage', etc.
  status          String   @default("active") // 'active' | 'cancelled' | 'expired'

  // Pricing
  monthlyPrice    Decimal  @db.Decimal(10, 2) // USD per month
  stripePriceId   String?  // Stripe subscription price ID
  stripeSubId     String?  @unique // Stripe subscription ID

  // Storage limits
  extraRetentionDays Int?     // Additional days beyond tier default (null = unlimited)
  maxStorageGB       Decimal? @db.Decimal(10, 2) // Max storage in GB (null = unlimited)
  currentStorageGB   Decimal  @default(0) @db.Decimal(10, 2) // Current usage in GB

  // Period tracking
  periodStart DateTime
  periodEnd   DateTime

  // Cancellation
  cancelledAt DateTime?
  expiresAt   DateTime? // When addon expires (after cancellation grace period)

  @@index([userId])
  @@index([status])
  @@index([periodEnd])
}

// ============================================================================
// MARKETPLACE INTELLIGENCE (Amazon/Etsy Data)
// ============================================================================

// Individual products scraped from marketplaces
model MarketplaceProduct {
  id        String   @id @default(cuid())
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Source identification
  source        String   // 'amazon' | 'etsy'
  externalId    String   // ASIN for Amazon, listing ID for Etsy
  url           String?

  // Merch by Amazon identification
  isMerchByAmazon   Boolean  @default(false) // True if "Amazon Merch on Demand" tag present
  mbaDetectedAt     DateTime? // When MBA status was detected

  // Product data
  title         String
  price         Decimal  @db.Decimal(10, 2)
  currency      String   @default("USD")
  reviewCount   Int      @default(0)
  avgRating     Decimal? @db.Decimal(3, 2)
  salesRank     Int?
  category      String?
  seller        String?
  imageUrl      String?

  // Niche association
  niche         String   // Search query that found this product
  nicheData     NicheMarketData? @relation(fields: [nicheId], references: [id])
  nicheId       String?

  // AI-extracted design analysis
  hasText           Boolean? // Does the design have text?
  extractedText     String?  // Text content on the design
  designStyle       String?  // 'vintage', 'minimalist', 'streetwear', etc.
  visualElements    Json?    // Array of detected elements
  colorScheme       String?  // Detected color palette
  designAnalyzedAt  DateTime? // When AI analyzed this design

  // Enhanced listing analysis (for learning)
  titleWordCount    Int?
  titleCharCount    Int?     // Total character count of title
  titleKeywords     Json?    // Extracted keywords from title
  primaryKeywords   String[] // Long-tail keyword phrases (3+ words)
  keywordRepetitions Json?   // {"keyword": count} - how many times each keyword repeats
  designTextInTitle Boolean? // True if title suggests design has text (e.g., "funny saying")

  bulletPoints      Json?    // If available
  bullet1CharCount  Int?     // Character count of first bullet point
  hasGiftKeyword    Boolean? // Contains "gift" in title
  hasFunnyKeyword   Boolean? // Contains "funny" in title

  // Brand strategy analysis
  brandStyle        String?  // 'studio_name' | 'generic' | 'niche_specific' | 'keyword_brand'
  brandName         String?  // Extracted brand name if present

  // Performance signals
  isTopSeller       Boolean  @default(false) // In top 10 for its niche
  performanceScore  Decimal? @db.Decimal(5, 2) // Calculated score (reviews * rating / rank)

  // BSR history tracking
  bsrHistory        BsrHistory[]
  bsrChange24h      Int?     // BSR change in last 24 hours (negative = improving)
  bsrChange7d       Int?     // BSR change in last 7 days
  bsrSpikeDetected  Boolean  @default(false) // True if significant BSR improvement detected
  bsrSpikeDate      DateTime? // When spike was detected

  // Freshness
  lastScrapedAt     DateTime @default(now())
  scrapedCount      Int      @default(1)

  @@unique([source, externalId])
  @@index([niche])
  @@index([source])
  @@index([designStyle])
  @@index([isTopSeller])
  @@index([lastScrapedAt])
  @@index([isMerchByAmazon])
  @@index([bsrSpikeDetected])
}

// Aggregated market data per niche (updated periodically)
model NicheMarketData {
  id        String   @id @default(cuid())
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Niche identification
  niche         String   @unique // Normalized search term
  lastAnalyzed  DateTime @default(now())

  // Market size
  totalProducts     Int      @default(0)
  amazonProducts    Int      @default(0)
  etsyProducts      Int      @default(0)
  mbaProducts       Int      @default(0) // Merch by Amazon products count

  // Saturation
  saturationLevel   String   @default("unknown") // 'low' | 'medium' | 'high' | 'oversaturated'
  competitionScore  Decimal? @db.Decimal(5, 2) // 0-100 score

  // Entry recommendation (ENTER/CAUTION/AVOID)
  entryRecommendation String  @default("unknown") // 'enter' | 'caution' | 'avoid' | 'unknown'
  entryReason         String? // Human-readable explanation for recommendation
  entryConfidence     Decimal? @db.Decimal(5, 2) // 0-100 confidence in recommendation

  // Pricing
  avgPrice          Decimal? @db.Decimal(10, 2)
  minPrice          Decimal? @db.Decimal(10, 2)
  maxPrice          Decimal? @db.Decimal(10, 2)
  optimalPricePoint Decimal? @db.Decimal(10, 2) // Most common successful price

  // Performance metrics
  avgReviewCount    Decimal? @db.Decimal(10, 2)
  avgRating         Decimal? @db.Decimal(3, 2)
  topSellerThreshold Int?    // Review count needed to be competitive

  // BSR trend analysis
  avgBsr            Int?     // Average BSR in this niche
  bsrTrend          String?  // 'improving' | 'stable' | 'declining'
  risingProductCount Int     @default(0) // Products with BSR spikes

  // Patterns learned
  winningDesignStyles   Json?  // ['vintage', 'minimalist'] - most common among top sellers
  effectiveKeywords     Json?  // Keywords in top-performing titles
  commonPricePoints     Json?  // [16.99, 19.99, 24.99]
  titlePatterns         Json?  // Common title structures

  // Keyword analysis
  longTailKeywords      Json?  // 3+ word phrases that perform well
  keywordDensity        Json?  // Average keyword usage patterns

  // Opportunities
  detectedGaps          Json?  // Identified market gaps
  emergingAngles        Json?  // New angles not well-served
  opportunityScore      Decimal? @db.Decimal(5, 2) // Overall opportunity rating

  // Fusion opportunities
  fusionOpportunities   NicheFusion[] @relation("PrimaryNiche")
  fusionAsSecondary     NicheFusion[] @relation("SecondaryNiche")

  // Related products
  products          MarketplaceProduct[]

  // Usage tracking
  queryCount        Int      @default(1) // How many times users searched this niche
  lastQueriedAt     DateTime @default(now())

  @@index([niche])
  @@index([saturationLevel])
  @@index([opportunityScore])
  @@index([lastAnalyzed])
  @@index([entryRecommendation])
}

// Learned patterns from successful listings (updated by learning engine)
model ListingPattern {
  id        String   @id @default(cuid())
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Pattern type
  patternType   String   // 'title_structure' | 'keyword' | 'price_strategy' | 'design_style'
  category      String   @default("apparel") // Product category this applies to

  // Pattern details
  pattern       String   // The actual pattern (e.g., "{Adjective} {Topic} {Audience} Shirt")
  examples      Json     // Array of real examples
  description   String?  // Human-readable description

  // Effectiveness metrics
  sampleSize    Int      @default(0) // Number of products this was learned from
  avgPerformance Decimal? @db.Decimal(5, 2) // Average performance score of products with this pattern
  successRate   Decimal? @db.Decimal(5, 2) // % of products with this pattern that are top sellers

  // Confidence
  confidence    Decimal  @default(0) @db.Decimal(5, 2) // 0-100 confidence in this pattern
  isActive      Boolean  @default(true) // Still recommended

  // Learning metadata
  lastValidated DateTime @default(now()) // When we last confirmed this pattern works
  validationCount Int    @default(1) // How many times pattern has been validated

  @@unique([patternType, pattern, category])
  @@index([patternType])
  @@index([category])
  @@index([confidence])
  @@index([isActive])
}

// Design style effectiveness tracking
model DesignStyleMetrics {
  id        String   @id @default(cuid())
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Style identification
  styleName     String   @unique // 'vintage', 'minimalist', 'streetwear', etc.

  // Performance in marketplace
  totalProducts     Int      @default(0)
  topSellerCount    Int      @default(0)
  avgReviewCount    Decimal? @db.Decimal(10, 2)
  avgRating         Decimal? @db.Decimal(3, 2)

  // Niche effectiveness
  bestPerformingNiches  Json?  // Niches where this style works best
  worstPerformingNiches Json?  // Niches to avoid

  // Price correlation
  avgPricePoint     Decimal? @db.Decimal(10, 2)
  priceRange        Json?    // {min, max, optimal}

  // Our platform performance
  generationCount   Int      @default(0) // How many times we generated this style
  downloadRate      Decimal? @db.Decimal(5, 2) // % of generations downloaded
  regenerationRate  Decimal? @db.Decimal(5, 2) // % that needed regeneration

  // Trend status
  isTrending        Boolean  @default(false)
  trendDirection    String?  // 'rising' | 'stable' | 'declining'
  lastTrendCheck    DateTime @default(now())

  @@index([styleName])
  @@index([isTrending])
}

// Marketplace scraping job tracking
model MarketplaceScrapeJob {
  id        String   @id @default(cuid())
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Job details
  jobType       String   // 'niche_scan' | 'product_update' | 'full_refresh'
  niche         String?  // Niche being scraped (null for full refresh)
  source        String   // 'amazon' | 'etsy' | 'both'

  // Status
  status        String   @default("pending") // 'pending' | 'running' | 'completed' | 'failed'
  startedAt     DateTime?
  completedAt   DateTime?
  errorMessage  String?

  // Results
  productsFound     Int?
  productsUpdated   Int?
  newProducts       Int?
  apiCallsUsed      Int?
  costEstimate      Decimal? @db.Decimal(10, 4) // Estimated API cost

  // Scheduling
  scheduledFor  DateTime? // When job should run
  priority      Int       @default(5) // 1=highest, 10=lowest

  @@index([status])
  @@index([scheduledFor])
  @@index([niche])
}

// ============================================================================
// BSR HISTORY TRACKING (Best Seller Rank over time)
// ============================================================================

model BsrHistory {
  id        String   @id @default(cuid())
  createdAt DateTime @default(now())

  // Product relation
  productId     String
  product       MarketplaceProduct @relation(fields: [productId], references: [id], onDelete: Cascade)

  // BSR data point
  bsr           Int      // Best Seller Rank at this time
  recordedAt    DateTime @default(now())

  // Calculated changes (from previous record)
  previousBsr   Int?     // Previous BSR value
  bsrChange     Int?     // Difference (negative = improving)
  changePercent Decimal? @db.Decimal(8, 2) // Percentage change

  // Spike detection
  isSpike       Boolean  @default(false) // True if this is a significant improvement
  spikeType     String?  // 'minor' (<25%) | 'major' (25-50%) | 'viral' (>50%)

  @@index([productId])
  @@index([recordedAt])
  @@index([isSpike])
}

// ============================================================================
// NICHE FUSION OPPORTUNITIES (Cross-niche combinations)
// ============================================================================

model NicheFusion {
  id        String   @id @default(cuid())
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // The two niches being combined
  niche1        String   // Primary niche (e.g., "nurse")
  niche2        String   // Secondary niche (e.g., "dog lover")
  nicheData1    NicheMarketData? @relation("PrimaryNiche", fields: [niche1Id], references: [id])
  niche1Id      String?
  nicheData2    NicheMarketData? @relation("SecondaryNiche", fields: [niche2Id], references: [id])
  niche2Id      String?

  // Combined query
  fusionQuery   String   // e.g., "nurse dog lover shirt"

  // Performance metrics
  productCount  Int      @default(0) // Products found with this fusion
  avgReviews    Decimal? @db.Decimal(10, 2)
  avgBsr        Int?
  topProduct    Json?    // Best performing product in this fusion

  // Opportunity assessment
  opportunityScore    Decimal? @db.Decimal(5, 2) // 0-100 score
  saturationLevel     String   @default("unknown") // 'low' | 'medium' | 'high'
  recommendation      String   @default("unknown") // 'enter' | 'caution' | 'avoid'

  // Why this fusion works (or doesn't)
  reasoningNotes      String?  // AI-generated explanation
  estimatedAudience   String?  // Description of target audience

  // Examples found
  exampleProducts     Json?    // Array of successful fusion products

  // Validation
  lastValidated       DateTime @default(now())
  validationCount     Int      @default(1)

  @@unique([niche1, niche2])
  @@index([niche1])
  @@index([niche2])
  @@index([opportunityScore])
  @@index([recommendation])
}

// ============================================================================
// MERCH DESIGN GENERATOR (Standalone Feature)
// ============================================================================

model MerchDesign {
  id                String   @id @default(cuid())
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt

  userId            String

  // Generation mode
  mode              String   // 'autopilot' | 'manual'

  // Autopilot fields
  riskLevel         Int?
  sourceData        Json?

  // Manual fields
  userSpecs         Json?

  // Common fields
  phrase            String
  niche             String
  style             String?
  tone              String?

  // Generated assets
  imageUrl          String
  imagePrompt       String
  listingTitle      String
  listingBullets    String[]
  listingDesc       String

  // Performance tracking
  approved          Boolean  @default(false)
  approvedAt        DateTime?
  userRating        Int?
  views             Int      @default(0)
  sales             Int      @default(0)
  isTest            Boolean  @default(false)

  // Relationships for variations
  variations        MerchDesign[] @relation("Variations")
  parentId          String?
  parent            MerchDesign?  @relation("Variations", fields: [parentId], references: [id])

  @@index([userId])
  @@index([createdAt])
  @@index([mode])
}

// ============================================================================
// MARKET INTELLIGENCE (Background Data Collection)
// ============================================================================

model MarketData {
  id          String   @id @default(cuid())
  createdAt   DateTime @default(now())

  source      String   // 'grok' | 'brave' | 'google' | 'multi-agent'
  category    String   // 'proven' | 'emerging' | 'moonshot'
  query       String?  // What was searched
  data        Json     // The actual results
  metadata    Json?    // Additional context

  @@index([source, createdAt])
  @@index([category, createdAt])
  @@index([createdAt])
}

model NicheTrend {
  id          String   @id @default(cuid())
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  niche       String   @unique // 'nurses' | 'teachers' | 'dog-lovers' etc
  category    String   // 'profession' | 'hobby' | 'pet' | 'lifestyle'

  // Trend metrics
  searchVolume    Int     @default(0)
  growthRate      Float   @default(0)
  competition     String  // 'low' | 'medium' | 'high'

  // Insights
  popularPhrases  String[]
  commonKeywords  String[]
  successPatterns Json?

  // Freshness
  lastAnalyzed    DateTime @default(now())

  @@index([category])
  @@index([lastAnalyzed])
}

// ============================================================================
// PROVEN INSIGHTS (Permanent Knowledge Repository)
// ============================================================================
// These are high-confidence patterns extracted from historical data.
// Unlike raw MarketData, ProvenInsights are PERMANENT and SACRED.
// They represent validated knowledge that compounds over time.

model ProvenInsight {
  id              String   @id @default(cuid())
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  // Classification
  insightType     String   // 'phrase-pattern' | 'niche-timing' | 'style-effectiveness' | 'listing-structure' | 'cross-niche'
  category        String   // 'evergreen' | 'seasonal' | 'design' | 'listing' | 'approval'

  // The Insight
  title           String   // Human-readable summary
  description     String   @db.Text // Detailed explanation
  pattern         Json     // Structured pattern data (flexible schema)

  // Evidence & Confidence
  sampleSize      Int      // Number of designs/data points this is based on
  confidence      Float    // 0-1 confidence score (0.8+ = high confidence)
  successRate     Float?   // Success rate (approval rate, conversion rate, etc.)
  avgPerformance  Json?    // Average metrics (sales, views, etc.)

  // Context & Applicability
  niche           String?  // Specific niche or null for general
  niches          String[] // Multiple applicable niches
  timeframe       String?  // 'year-round' | 'holiday-season' | 'mothers-day' | etc.
  riskLevel       String?  // 'proven' | 'emerging' | 'moonshot'

  // Validation & Lifecycle
  lastValidated   DateTime @default(now())
  timesValidated  Int      @default(1)
  stillRelevant   Boolean  @default(true)
  supersededBy    String?  // ID of newer insight that replaces this

  // Source tracking
  sourceDataIds   String[] // IDs of data that contributed to this insight

  @@index([insightType])
  @@index([category])
  @@index([niche])
  @@index([stillRelevant])
  @@index([confidence])
  @@index([createdAt])
}

// ============================================================================
// NICHE STYLE PROFILES (AI-Discovered Design Styles per Niche)
// ============================================================================
// Style characteristics discovered by analyzing actual MBA product images.
// These profiles guide image generation to match what sells in each niche.

model NicheStyleProfile {
  id              String   @id @default(cuid())
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  // Niche identification
  niche           String   @unique // Normalized niche name
  version         Int      @default(1) // Profile version for updates

  // Sample data
  sampleSize      Int      @default(0) // Number of products analyzed
  sourceSampleIds String[] // ASINs/IDs of analyzed products
  confidence      Float    @default(0) // 0-1 confidence in this profile

  // Typography patterns discovered
  typographyDominant    String[] // Most common typography styles
  typographySuccessful  String[] // Typography in top-sellers
  typographyAvoided     String[] // Typography rarely seen/performing poorly

  // Color palette patterns
  colorPalettesCommon      String[] // Commonly used color combinations
  colorPalettesSuccessful  String[] // Colors in top-selling designs
  colorsByShirtColor       Json?    // {"black": ["white", "neon"], "white": ["black", "navy"]}

  // Mood/aesthetic patterns
  moodPrimary       String[] // Primary aesthetic keywords (e.g., "vintage", "bold")
  moodSecondary     String[] // Secondary aesthetic keywords
  moodAvoided       String[] // Styles that don't work for this niche
  moodReference     String?  // Description of overall aesthetic

  // Layout patterns
  layoutCompositions   String[] // Common composition styles
  layoutTextPlacements String[] // Where text typically appears
  layoutIconUsage      Float    @default(0) // 0-1 percentage of designs with icons
  layoutIconStyles     String[] // Common icon styles when present

  // Audience insights (discovered from product data)
  audienceDemographics    String? // Who buys these products
  audiencePsychographics  String? // Values, interests
  audienceMotivations     String[] // Why they buy

  // Cross-niche relationships
  relatedNiches           String[] // Niches with similar style preferences
  nicheBlendOpportunities String[] // Potential cross-niche fusions

  // Performance tracking
  designsGenerated        Int      @default(0) // How many designs used this profile
  avgComplianceScore      Float?   // Average compliance score of generated designs
  downloadRate            Float?   // % of designs downloaded

  // Freshness
  lastAnalyzedAt          DateTime @default(now())
  analysisCount           Int      @default(1)

  @@index([niche])
  @@index([confidence])
  @@index([lastAnalyzedAt])
}

// ============================================================================
// CROSS-NICHE OPPORTUNITIES (AI-Detected Niche Combinations)
// ============================================================================
// Opportunities where combining two niches creates untapped market potential.
// E.g., "fishing + coffee" or "nurse + dog mom" - validated against Amazon data.

model CrossNicheOpportunity {
  id              String   @id @default(cuid())
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  // The combination
  primaryNiche    String   // First niche (e.g., "fishing")
  secondaryNiche  String   // Second niche (e.g., "coffee")
  combinedQuery   String   // Search query for validation (e.g., "fishing coffee shirt")

  // Discovery source
  discoveryMethod String   // 'ai-synthesis' | 'trend-correlation' | 'customer-overlap' | 'manual'
  discoveredBy    String?  // AI model or user that discovered this

  // Amazon validation results
  productCount        Int      @default(0) // Products found with this combination
  avgBsr              Int?     // Average BSR of existing products
  avgReviewCount      Float?   // Average reviews
  topCompetitorAsin   String?  // Best-selling competitor
  marketGap           String?  // Description of identified gap

  // Opportunity assessment
  opportunityScore    Float    @default(0) // 0-100 overall score
  saturationLevel     String   @default("unknown") // 'low' | 'medium' | 'high' | 'oversaturated'
  recommendation      String   @default("unknown") // 'strong_enter' | 'enter' | 'caution' | 'avoid'
  confidenceLevel     Float    @default(0) // 0-1 confidence in assessment

  // Why this works (AI reasoning)
  audienceOverlap     String?  // Description of overlapping audience
  emotionalHook       String?  // Why this combination resonates
  uniqueAngle         String?  // What makes this combination special
  suggestedPhrases    String[] // AI-suggested design phrases
  suggestedStyles     String[] // Recommended design styles

  // Design guidance
  recommendedStyle    String?  // Best style for this fusion
  styleBlendRatio     String?  // How to blend styles (e.g., "70% fishing rugged, 30% coffee cozy")
  colorRecommendation String?  // Suggested color approach
  toneRecommendation  String?  // Suggested tone

  // Validation tracking
  validationCount     Int      @default(1)
  lastValidatedAt     DateTime @default(now())
  validationHistory   Json?    // Array of {date, score, productCount}

  // Performance after use
  timesUsed           Int      @default(0)
  designsGenerated    Int      @default(0)
  avgDesignQuality    Float?   // Average quality score of designs using this
  downloadRate        Float?   // % of designs downloaded

  // Status
  isActive            Boolean  @default(true) // Still a valid opportunity
  deactivatedReason   String?  // Why it was deactivated
  expiresAt           DateTime? // When to re-validate

  @@unique([primaryNiche, secondaryNiche])
  @@index([primaryNiche])
  @@index([secondaryNiche])
  @@index([opportunityScore])
  @@index([recommendation])
  @@index([isActive])
  @@index([lastValidatedAt])
}

// ============================================================================
// GENERATION HISTORY (Diversity Engine - Tracks What Was Generated)
// ============================================================================
// Tracks all generated designs to prevent repetition and ensure diversity.
// The diversity engine uses this to:
// 1. Avoid generating the same niche/phrase combinations
// 2. Score novelty of new ideas
// 3. Track what's working and what isn't

model GenerationHistory {
  id          String   @id @default(cuid())
  createdAt   DateTime @default(now())

  // What was generated
  userId      String   // User who generated (or 'system' for cron)
  phrase      String   // The phrase on the shirt (lowercase for matching)
  niche       String   // The niche category (lowercase for matching)
  topic       String   // The topic/trend that inspired it (lowercase)
  riskLevel   Int      // 0-100 risk level used

  // Timestamps for diversity calculations
  generatedAt DateTime @default(now())

  // Outcome tracking (updated later)
  wasApproved   Boolean?  // Did user approve/download?
  wasPublished  Boolean?  // Did user publish to marketplace?
  userRating    Int?      // 1-5 user rating
  performanceScore Float? // Calculated performance score

  // Diversity tracking
  diversityScore Float?   // 0-1 diversity score when generated
  nicheNovelty   Float?   // How novel the niche was
  phraseNovelty  Float?   // How novel the phrase was

  // Source tracking
  source         String?  // 'autopilot' | 'manual' | 'exploration' | 'cross-niche'
  discoveryMethod String? // How this idea was found

  @@index([userId])
  @@index([phrase])
  @@index([niche])
  @@index([topic])
  @@index([generatedAt])
  @@index([userId, generatedAt])
  @@index([niche, generatedAt])
}

// ============================================================================
// DISCOVERED NICHES (Dynamic Niche Discovery Cache)
// ============================================================================
// Caches AI-discovered niches so we don't have to re-discover them constantly.
// Niches expire and get re-evaluated to keep the system fresh.

model DiscoveredNiche {
  id            String   @id @default(cuid())
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  // Niche info
  niche         String   @unique
  description   String?
  audienceSize  String?  // 'massive' | 'large' | 'medium' | 'niche' | 'micro'
  trendDirection String? // 'exploding' | 'growing' | 'stable' | 'declining'
  competitionLevel String? // 'blue_ocean' | 'low' | 'medium' | 'high' | 'saturated'

  // Suggested content
  suggestedPhrases String[]
  relatedNiches    String[]

  // Discovery metadata
  source        String   // 'ai-discovery' | 'trend-analysis' | 'user-submitted' | 'static'
  focusArea     String?  // 'evergreen' | 'trending' | 'emerging' | 'seasonal'
  discoveredAt  DateTime @default(now())

  // Usage and performance
  timesUsed     Int      @default(0)
  lastUsedAt    DateTime?
  avgPerformance Float?  // Average performance of designs in this niche

  // Status
  isActive      Boolean  @default(true)
  expiresAt     DateTime? // When to re-evaluate this niche

  @@index([niche])
  @@index([source])
  @@index([isActive])
  @@index([timesUsed])
  @@index([trendDirection])
}

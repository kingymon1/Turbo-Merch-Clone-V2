# Vectorizer.AI Integration

## Overview

This integration allows us to convert raster images generated by Gemini (Nano Banana Pro) into high-quality vectorized images using the Vectorizer.AI API. The vectorized PNG output is 4x the resolution of the input image.

## Official Documentation

- **API Documentation**: https://vectorizer.ai/api
- **Output Options**: https://vectorizer.ai/api/outputOptions

## How We're Using the API

### Flow

1. **Generate Image**: User triggers image generation using Gemini 3 Pro (Nano Banana)
2. **Send to Vectorizer**: The generated image (base64 PNG) is sent to Vectorizer.AI
3. **Receive Vectorized PNG**: Vectorizer.AI returns a vectorized PNG at 4x resolution
4. **Deliver to User**: The high-quality vectorized image is available for download

### API Endpoints

We've created two endpoints:

#### 1. Standalone Vectorization: `POST /api/vectorize`

Vectorize any image (base64 or URL):

```typescript
// Request
{
  "imageDataUrl": "data:image/png;base64,...", // OR
  "imageUrl": "https://example.com/image.png",
  "outputFormat": "png",       // svg, pdf, eps, dxf, png
  "mode": "production",        // production or test
  "retentionDays": 0,          // 0-365, for downloading additional formats
  "maxColors": null            // optional color limit
}

// Response
{
  "success": true,
  "imageUrl": "data:image/png;base64,...",
  "format": "png",
  "imageToken": "...",         // for downloading additional formats
  "receipt": "...",            // for downloading additional formats
  "creditsUsed": 1
}
```

#### 2. Combined Generate + Vectorize: `POST /api/gemini/generate-and-vectorize`

Generate with Gemini and automatically vectorize:

```typescript
// Request (same as /api/gemini/generate-image, plus vectorization options)
{
  // Generation options
  "basicPrompt": "A vintage sunset design",
  "style": "streetwear",
  "textOnDesign": "SUMMER VIBES",

  // Or use trend-based generation
  "trend": { /* TrendData object */ },
  "useEnhancedResearch": true,

  // Vectorization options
  "vectorize": true,           // set to false to skip vectorization
  "outputFormat": "png",
  "vectorizerMode": "production"
}

// Response
{
  "success": true,
  "imageUrl": "data:image/png;base64,...",         // Vectorized image
  "originalImageUrl": "data:image/png;base64,...", // Original generated image
  "format": "png",
  "research": { /* DesignResearch object */ },
  "vectorized": true,
  "creditsUsed": 1
}
```

## API Key Configuration

### Environment Variables

Add these to your `.env` file:

```env
# Vectorizer.AI (Required for vectorization feature)
VECTORIZER_API_ID=your_api_id_here
VECTORIZER_API_SECRET=your_api_secret_here
```

### Getting API Credentials

1. Go to https://vectorizer.ai/api
2. Create an account or sign in
3. Navigate to API credentials section
4. Copy your **API ID** and **API Secret**

### Security Notes

- **NEVER** expose these credentials client-side
- Both `VECTORIZER_API_ID` and `VECTORIZER_API_SECRET` are server-only (no `NEXT_PUBLIC_` prefix)
- All vectorization requests must go through our API routes

## Input Requirements

### Image Limits (from Vectorizer.AI)

| Limit | Value |
|-------|-------|
| Max pixel size | 3 megapixels |
| Max file size | 30 MB |
| Supported formats | PNG, JPEG, WEBP, BMP, GIF |
| Color depth | 32-bit ARGB (full transparency support) |

### Output Characteristics

| Format | Notes |
|--------|-------|
| **PNG** | 4x input resolution (up to 4 megapixels cap) |
| SVG | Default format, most flexible |
| PDF | Vector PDF output |
| EPS | Encapsulated PostScript |
| DXF | AutoCAD format |

## Code Files

| File | Purpose |
|------|---------|
| `services/vectorizerService.ts` | Core vectorization logic and API interaction |
| `app/api/vectorize/route.ts` | Standalone vectorization endpoint |
| `app/api/gemini/generate-and-vectorize/route.ts` | Combined generation + vectorization |

## Usage Examples

### Basic Vectorization (from Frontend)

```typescript
const vectorizeImage = async (imageDataUrl: string) => {
  const response = await fetch('/api/vectorize', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({
      imageDataUrl,
      outputFormat: 'png',
      mode: 'production'
    })
  });

  const result = await response.json();
  return result.imageUrl; // Vectorized PNG as base64 data URL
};
```

### Generate and Vectorize (from Frontend)

```typescript
const generateVectorizedDesign = async (trend: TrendData) => {
  const response = await fetch('/api/gemini/generate-and-vectorize', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({
      trend,
      useEnhancedResearch: true,
      outputFormat: 'png',
      vectorizerMode: 'production'
    })
  });

  const result = await response.json();

  return {
    vectorizedImage: result.imageUrl,
    originalImage: result.originalImageUrl,
    research: result.research
  };
};
```

### Service-Level Usage (Server-Side)

```typescript
import { vectorizeImage, generateAndVectorize } from '@/services/vectorizerService';
import { generateDesignImage } from '@/services/geminiService';

// Option 1: Vectorize existing image
const result = await vectorizeImage(existingImageDataUrl, {
  outputFormat: 'png',
  mode: 'production'
});

// Option 2: Generate and vectorize in one call
const result = await generateAndVectorize(
  () => generateDesignImage(prompt, style, textOnDesign),
  { outputFormat: 'png' }
);
```

## Error Handling

### Common Errors

| Error | Cause | Solution |
|-------|-------|----------|
| `credentials not configured` | Missing env vars | Add `VECTORIZER_API_ID` and `VECTORIZER_API_SECRET` |
| `exceeds 30MB limit` | File too large | Reduce image quality or dimensions before sending |
| `timed out after 180 seconds` | Processing too slow | Try again or check Vectorizer.AI status |
| `API error (401)` | Invalid credentials | Verify API ID and Secret are correct |
| `API error (429)` | Rate limited | Reduce request frequency |

### Timeout Configuration

- Vectorizer.AI recommends **180 seconds** minimum timeout
- Our endpoints are configured for **300 seconds** (Vercel Pro max)
- For very large images, processing may take longer

## Pricing Considerations

### Modes

- **Production**: Full quality output (standard pricing)
- **Test**: Preview mode (lower cost, useful for development)

Use `mode: 'test'` during development to minimize costs:

```typescript
const result = await vectorizeImage(imageUrl, {
  mode: process.env.NODE_ENV === 'production' ? 'production' : 'test'
});
```

### Multiple Formats

If you need multiple output formats (e.g., PNG and SVG), use the retention feature:

```typescript
// First request with retention
const result = await vectorizeImage(imageUrl, {
  outputFormat: 'png',
  retentionDays: 1  // Keep for 1 day
});

// Download additional format using token/receipt
const svgResult = await downloadAdditionalFormat(
  result.imageToken,
  result.receipt,
  'svg'
);
```

This is cheaper than vectorizing the same image twice.

## Future Improvements

1. **Caching**: Cache vectorized results to avoid re-processing identical images
2. **Batch Processing**: Support vectorizing multiple images in parallel
3. **Format Selection UI**: Let users choose output format (SVG, PNG, PDF)
4. **Preview Mode**: Use test mode for previews, production for final downloads

## Troubleshooting

### Image Not Vectorizing

1. Check image is under 3 megapixels
2. Verify file size is under 30MB
3. Ensure format is PNG, JPEG, WEBP, BMP, or GIF
4. Check API credentials are set correctly

### Poor Quality Output

1. Ensure input image has clean edges (vectorization works best with distinct shapes)
2. Try increasing `maxColors` if colors look washed out
3. Consider using SVG output for maximum quality

### Slow Processing

1. Large/complex images take longer to process
2. Check Vectorizer.AI status page for service issues
3. Consider using test mode for development

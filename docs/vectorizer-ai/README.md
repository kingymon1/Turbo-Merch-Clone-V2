# Vectorizer.AI Integration

## Overview

This integration allows us to convert raster images generated by Gemini (Nano Banana Pro) into high-quality vectorized images using the Vectorizer.AI API. The vectorized PNG output is 4x the resolution of the input image.

**Key Features:**
- HD Vector PNG downloads for paid subscribers
- Automatic caching (each image vectorized only once)
- Feature toggle via environment variable
- Seamless integration with existing download flow

## Official Documentation

- **API Documentation**: https://vectorizer.ai/api
- **Output Options**: https://vectorizer.ai/api/outputOptions

## How It Works

### Download Flow

```
User clicks "Download" button
        ‚Üì
Modal appears: "Standard" or "HD Vector PNG"
        ‚Üì
    ‚îå‚îÄ‚îÄ‚îÄ‚î¥‚îÄ‚îÄ‚îÄ‚îê
    ‚îÇ       ‚îÇ
Standard    HD (paid only)
    ‚îÇ       ‚îÇ
    ‚Üì       ‚Üì
            Check if already vectorized (cached)?
            ‚îú‚îÄ‚îÄ YES ‚Üí Return cached URL (instant)
            ‚îî‚îÄ‚îÄ NO  ‚Üí Vectorize ‚Üí Cache in R2 ‚Üí Return
    ‚Üì       ‚Üì
Background removal (canvas API)
        ‚Üì
Add to ZIP ‚Üí Download
```

### Cost Control

- **Vectorization happens at download time**, not generation time
- Each image gets **one free vectorization** (cached forever)
- Re-downloads use cached version (no additional cost)
- Free trial users see the option but cannot use it (upsell)

## API Endpoints

### 1. Vectorize for Download: `POST /api/vectorize/download`

The main endpoint used by the Library component. Handles caching automatically.

```typescript
// Request
{
  "designId": "clx123...",     // Required - design to vectorize
  "imageUrl": "https://..."    // Optional - uses design's imageUrl if not provided
}

// Response (first time - vectorizes and caches)
{
  "success": true,
  "imageUrl": "data:image/png;base64,...",  // For immediate use
  "storageUrl": "https://r2.../vectors/...", // Cached in R2
  "format": "png",
  "fromCache": false,
  "creditsUsed": 1
}

// Response (subsequent - from cache)
{
  "success": true,
  "imageUrl": "https://r2.../vectors/...",
  "format": "png",
  "fromCache": true
}
```

### 2. Check Vectorization Status: `GET /api/vectorize/download?designId=xxx`

Check if an image has been vectorized.

```typescript
// Response
{
  "enabled": true,
  "hasAccess": true,           // Based on user's tier
  "currentTier": "pro",
  "isVectorized": true,        // Already cached?
  "vectorizedUrl": "https://...",
  "vectorizedAt": "2024-01-15T..."
}
```

### 3. Standalone Vectorization: `POST /api/vectorize`

Direct vectorization without caching (for other use cases).

```typescript
// Request
{
  "imageDataUrl": "data:image/png;base64,...", // OR
  "imageUrl": "https://example.com/image.png",
  "outputFormat": "png",
  "mode": "production"
}
```

## API Key Configuration

### Environment Variables

```env
# Vectorizer.AI API Credentials (Required)
VECTORIZER_API_ID=your_api_id_here
VECTORIZER_API_SECRET=your_api_secret_here

# Feature Toggle (Required)
# Set to 'true' to show HD download option, 'false' to hide completely
NEXT_PUBLIC_VECTORIZER_ENABLED=false
```

### Getting API Credentials

1. Go to https://vectorizer.ai/api
2. Create an account or sign in
3. Subscribe to an API plan
4. Copy your **API ID** and **API Secret**

### Vercel Setup

Add these in Vercel Dashboard ‚Üí Settings ‚Üí Environment Variables:

| Variable | Value | Notes |
|----------|-------|-------|
| `VECTORIZER_API_ID` | Your API ID | From Vectorizer.AI dashboard |
| `VECTORIZER_API_SECRET` | Your API Secret | From Vectorizer.AI dashboard |
| `NEXT_PUBLIC_VECTORIZER_ENABLED` | `true` or `false` | Start with `false` |

## Tier Access

| Tier | Standard Download | HD Vector PNG |
|------|-------------------|---------------|
| Free Trial | ‚úÖ | üîí Locked (visible, upsell) |
| Starter | ‚úÖ | ‚úÖ |
| Pro | ‚úÖ | ‚úÖ |
| Business | ‚úÖ | ‚úÖ |
| Enterprise | ‚úÖ | ‚úÖ |

Free users see the HD option but cannot select it. Shows upgrade prompt.

## Feature Toggle

### Turning Off

Set `NEXT_PUBLIC_VECTORIZER_ENABLED=false` to:
- Hide the download quality modal completely
- Skip directly to standard download
- No trace of vectorizer in UI

### Turning On

Set `NEXT_PUBLIC_VECTORIZER_ENABLED=true` to:
- Show download quality selection modal
- Enable HD downloads for paid users
- Show locked state for free users

## Database Schema

Vectorization status is tracked in `DesignHistory`:

```prisma
model DesignHistory {
  // ... existing fields ...

  // Vectorized HD image (cached after first HD download)
  vectorizedUrl  String?   // R2 URL to cached vectorized HD image
  vectorizedAt   DateTime? // When the image was vectorized (null = not yet)
}
```

## Storage

Vectorized images are stored in R2:

```
R2 Bucket:
‚îú‚îÄ‚îÄ images/{userId}/{designId}.png       ‚Üê Original
‚îú‚îÄ‚îÄ vectors/{userId}/{designId}_hd.png   ‚Üê Vectorized (cached)
```

## Code Files

| File | Purpose |
|------|---------|
| `config.ts` | `VECTORIZER_CONFIG` with settings and allowed tiers |
| `services/vectorizerService.ts` | Core API integration and helper functions |
| `app/api/vectorize/route.ts` | Standalone vectorization endpoint |
| `app/api/vectorize/download/route.ts` | Download endpoint with caching |
| `components/Library.tsx` | Download UI with Standard/HD modal |
| `lib/r2-storage.ts` | R2 upload helpers |

## Pricing (Vectorizer.AI API)

| Credits/Month | Price/Month | Cost Per Image |
|---------------|-------------|----------------|
| 50 | $9.99 | $0.20 |
| 1,000 | $139.99 | $0.14 |
| 10,000 | $949.99 | $0.095 |
| 50,000 | $3,179.99 | $0.064 |
| 100,000 | $4,999.99 | **$0.05** |

At scale, each HD download costs ~$0.05.

Unused credits roll over (up to 5√ó monthly).

## Input Requirements

### Image Limits (from Vectorizer.AI)

| Limit | Value |
|-------|-------|
| Max pixel size | 3 megapixels |
| Max file size | 30 MB |
| Supported formats | PNG, JPEG, WEBP, BMP, GIF |
| Color depth | 32-bit ARGB (full transparency support) |

### Output Characteristics

- PNG output is **4x input resolution** (up to 4 megapixels cap)
- Cleaner edges due to vectorization
- Better for print-on-demand

## Error Handling

### Common Errors

| Error | Cause | Solution |
|-------|-------|----------|
| `credentials not configured` | Missing env vars | Add `VECTORIZER_API_ID` and `VECTORIZER_API_SECRET` |
| `HD Vector downloads require a paid subscription` | Free user | Upgrade to paid plan |
| `exceeds 30MB limit` | File too large | Image is auto-handled, shouldn't occur |
| `timed out after 180 seconds` | Processing too slow | Retry or check Vectorizer.AI status |
| `API error (401)` | Invalid credentials | Verify API ID and Secret |
| `API error (402)` | Out of credits | Top up Vectorizer.AI account |

### Graceful Degradation

If vectorization fails during HD download:
1. Warning logged to console
2. Falls back to original image
3. Download continues with standard quality
4. User gets their files (just not vectorized)

## Usage Examples

### From Library Component (Already Integrated)

The Library component handles everything automatically:

1. User selects designs
2. Clicks "Download"
3. Modal shows Standard/HD options
4. If HD: calls `/api/vectorize/download` for each design
5. Background removal applied
6. ZIP created and downloaded

### Manual Vectorization (Server-Side)

```typescript
import { vectorizeImage, vectorizeForHDDownload } from '@/services/vectorizerService';

// Basic vectorization
const result = await vectorizeImage(imageDataUrl, {
  outputFormat: 'png',
  mode: 'production'
});

// HD download pipeline
const hdResult = await vectorizeForHDDownload(imageDataUrl);
```

### Check Feature Status

```typescript
import { isVectorizerEnabled, tierHasVectorizerAccess } from '@/services/vectorizerService';

// Check if feature is on
if (isVectorizerEnabled()) {
  // Show HD option
}

// Check user access
if (tierHasVectorizerAccess(userTier)) {
  // Allow HD download
}
```

## Troubleshooting

### Feature Not Showing

1. Check `NEXT_PUBLIC_VECTORIZER_ENABLED=true` in Vercel
2. Redeploy after changing env vars
3. Check browser console for errors

### Vectorization Failing

1. Check API credentials are correct
2. Verify you have credits in Vectorizer.AI dashboard
3. Check image is under 30MB (should be automatic)
4. Look at server logs for specific error

### Slow Downloads

1. First HD download vectorizes (takes 10-30s per image)
2. Subsequent downloads use cache (instant)
3. For many images, consider downloading in batches

## Future Enhancements

1. ~~Caching~~ ‚úÖ Implemented
2. ~~Tier access control~~ ‚úÖ Implemented
3. ~~Feature toggle~~ ‚úÖ Implemented
4. **Batch optimization** - Vectorize in parallel
5. **Progress indicator** - Show per-image progress
6. **SVG option** - Offer SVG download for designers
7. **Usage tracking** - Track vectorizations per user
